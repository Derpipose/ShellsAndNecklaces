@page "/store"
@page "/store/{currentPage:int}"

@inject IDbContextFactory<OneShotShopContext> ContextFactory
@inject NavigationManager NavManager
@inject ILogger<ItemService> itemLogger
@using Microsoft.EntityFrameworkCore;
@using ShellAndNecklaceAPI
@using ShellAndNecklaceAPI.Data
@using ShellAndNecklaceAPI.Services;


<PageTitle>Shop</PageTitle>

<h3>Shop</h3>

<ul class="pagination mt-3">
    <li class="page-item @(currentPage == 1? "disabled" : "")">
        <a class="page-link" href="/store/@(currentPage - 1)">Previous</a>
    </li>
    @for (int i = 1; i <= totalPages; i++)
    {
        <li class="page-item @(currentPage == i? "active" : "")">
            <a class="page-link" href="/store/@i">@i</a>
        </li>
    }
    <li class="page-item @(currentPage == totalPages? "disabled" : "")">
        <a class="page-link" href="/store/@(currentPage + 1)">Next</a>
    </li>
</ul>

<select @bind="sortBy">
    <option value="name">Name</option>
    <option value="price">Price</option>
</select>

<select @bind="sortOrder">
    <option value="asc">Ascending</option>
    <option value="desc">Descending</option>
</select>

<button @onclick="HandleSortChangeAsync">Apply Sort</button>

@*Need style for each status, pagination, automatic making cards*@
@if (itemList != null && itemList.Any())
{
    @foreach (var item in itemList)
    {
<div class="card" style="width: 18rem;">
    <img class="card-img-top" src="@item.Picture" alt="picture of @item.Itemname">
    <div class="card-body">
        <h5 class="card-title">@item.Itemname</h5>
        <p class="card-text">Description</p>
                <a href="/store/item/@item.Id" class="btn btn-primary">@*item name from data*@</a>
    </div>
</div>
    }
}
else
{
    <p>No items found.</p>
}

@code {
    [Parameter]
    public int currentPage { get; set; } = 0;

    private List<Item> itemList;
    private int totalPages { get; set; }
    private string sortBy = "name"; // Default sorting by name
    private string sortOrder = "asc"; // Default sorting order
    private int itemsPerPage { get; set; } = 10;


    protected override async Task OnInitializedAsync()
    {
        
        var context = ContextFactory.CreateDbContext();
        ItemService itemService = new ItemService(itemLogger, context);
        await FetchItemsAsync();
        
    }

    private async Task FetchItemsAsync()
    {
        try {
            var context = ContextFactory.CreateDbContext();
            
            if (context.Items != null)
            {
                IQueryable<Item> query = context.Items.OrderBy(item => item.Itemname);

                if (sortBy == "name")
                {
                    query = sortOrder == "asc" ? query.OrderBy(item => item.Itemname) : query.OrderByDescending(item => item.Itemname);
                }
                else if (sortBy == "price")
                {
                    query = sortOrder == "asc" ? query.OrderBy(item => item.Pricebase) : query.OrderByDescending(item => item.Pricebase);
                }
            }
            else
            {
                totalPages = 1;
            }
            if (currentPage <= 0)
            {
                NavManager.NavigateTo("/store/1");
                return;
            }
            else { }
            var itemCount = itemList.Count();
            if (itemCount < 1)
            {
                totalPages = 1;
            }
            else
            {
                totalPages = (int)Math.Ceiling((decimal)itemCount / itemsPerPage);
            }

            if (currentPage > totalPages)
            {
                currentPage = totalPages;
                NavManager.NavigateTo($"/store/{totalPages}");
                return;
            }
            else { }
            itemList = await context.Items
            .Skip((currentPage - 1) * itemsPerPage)
            .Take(itemsPerPage)
            .ToListAsync();

        }
        catch (Exception e)
        {
            Console.WriteLine($"Error:{e.Message}");
        }
    }


    protected override async Task OnParametersSetAsync()
    {
    }
    
    private async Task HandleSortChangeAsync()
    {
        await FetchItemsAsync(); // Re-fetch items based on the updated sorting criteria
        StateHasChanged(); // Refresh UI
    }
}

@* 
drawing with mouse:
        canvas html tag
        javascript:
        getcontext
        mouse down event *@